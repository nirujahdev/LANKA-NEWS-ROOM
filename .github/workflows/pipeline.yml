name: News Pipeline Worker

# ============================================
# SETUP INSTRUCTIONS
# ============================================
# Before this workflow can run, you must:
# 1. Go to GitHub Repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
# 2. Add the following secrets:
#    - SUPABASE_URL: Your Supabase project URL
#    - SUPABASE_SERVICE_ROLE_KEY: Your Supabase service role key (for writes)
#    - OPENAI_API_KEY: Your OpenAI API key
# 3. Optionally set:
#    - SUMMARY_MODEL: OpenAI model to use (default: gpt-4o-mini)
#    - BATCH_SIZE: Number of articles to process per batch (default: 10)
# ============================================

on:
  # Schedule: Every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  
  # Manual trigger (for testing)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no database writes)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Prevent concurrent runs - queue new runs instead of canceling
# This ensures all runs complete, even if triggered multiple times
concurrency:
  group: pipeline-worker
  cancel-in-progress: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Increased from 15 to allow processing more articles
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Verify environment variables
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ]; then
            echo "‚ùå SUPABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå SUPABASE_SERVICE_ROLE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"

      - name: Run pipeline
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUMMARY_MODEL: ${{ secrets.SUMMARY_MODEL || 'gpt-4o-mini' }}
          BATCH_SIZE: ${{ secrets.BATCH_SIZE || '10' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "üöÄ Starting pipeline worker..."
          echo "   DRY_RUN: ${DRY_RUN}"
          echo "   BATCH_SIZE: ${BATCH_SIZE}"
          echo "   SUMMARY_MODEL: ${SUMMARY_MODEL}"
          
          # Run the pipeline script
          npx tsx scripts/pipeline.ts

      - name: Pipeline summary
        if: always()
        run: |
          echo "üìä Pipeline run completed"
          echo "Check the logs above for detailed statistics"

