name: Trigger Pipeline Cron (15 min)

# ============================================
# SETUP INSTRUCTIONS
# ============================================
# Before this workflow can run, you must:
# 1. Go to GitHub Repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
# 2. Click "New repository secret"
# 3. Name: CRON_SECRET
# 4. Value: Same as your Vercel CRON_SECRET environment variable (Production)
# 5. Click "Add secret"
#
# IMPORTANT: CRON_SECRET must match exactly in both places:
# - GitHub Secrets ‚Üí Actions ‚Üí CRON_SECRET
# - Vercel ‚Üí Project Settings ‚Üí Environment Variables ‚Üí CRON_SECRET (Production)
# ============================================

on:
  # Schedule: Every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  
  # Manual trigger (for testing)
  workflow_dispatch:

jobs:
  trigger-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call pipeline endpoint
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET secret is not set"
            echo "Please set CRON_SECRET secret in GitHub Settings ‚Üí Secrets ‚Üí Actions"
            exit 1
          fi
          
          # Using custom domain: lankanewsroom.xyz
          DOMAIN="lankanewsroom.xyz"
          ENDPOINT="https://${DOMAIN}/api/cron/run"
          
          echo "Triggering pipeline at ${ENDPOINT}"
          echo "Using CRON_SECRET: ${CRON_SECRET:0:8}..." # Show first 8 chars for debugging
          
          # Make request with Bearer token authentication
          # --location flag follows redirects (HTTP 301, 302, 307, 308)
          # --max-time sets timeout to 300 seconds (5 minutes) for long-running pipelines
          # --connect-timeout sets connection timeout to 30 seconds
          # --write-out prints status code and response
          # Use set +e to continue on curl errors (we'll check HTTP status instead)
          set +e
          response=$(curl \
            --location \
            --max-time 300 \
            --connect-timeout 30 \
            --silent \
            --show-error \
            --write-out "\nHTTP_STATUS:%{http_code}\nHTTP_TIME:%{time_total}\n" \
            --header "Authorization: Bearer ${CRON_SECRET}" \
            --header "Content-Type: application/json" \
            "${ENDPOINT}" 2>&1)
          curl_exit_code=$?
          set -e
          
          # Debug: Show raw response (first 500 chars)
          echo "=== Raw Response (first 500 chars) ==="
          echo "$response" | head -c 500
          echo ""
          echo "=== End Raw Response ==="
          
          # Extract HTTP status code (handle both formats)
          http_status=$(echo "$response" | grep -E "HTTP_STATUS:[0-9]+" | tail -1 | cut -d: -f2 | tr -d ' ' || echo "000")
          
          # Extract response body (everything except HTTP_STATUS and HTTP_TIME lines)
          body=$(echo "$response" | grep -v -E "HTTP_STATUS:|HTTP_TIME:" | tr -d '\0')
          
          # Extract time taken
          http_time=$(echo "$response" | grep -E "HTTP_TIME:" | tail -1 | cut -d: -f2 | tr -d ' ' || echo "0")
          
          echo "Curl exit code: $curl_exit_code"
          echo "HTTP Status: $http_status"
          echo "HTTP Time: ${http_time}s"
          echo "Response body length: ${#body} characters"
          
          # Show response body (truncated if too long)
          if [ ${#body} -gt 1000 ]; then
            echo "Response body (first 1000 chars):"
            echo "$body" | head -c 1000
            echo "..."
          else
            echo "Response body:"
            echo "$body"
          fi
          
          # Check for curl connection errors (exit code != 0 and no HTTP status)
          if [ "$curl_exit_code" -ne 0 ] && [ "$http_status" = "000" ]; then
            echo "‚ùå Connection failed (curl exit code: $curl_exit_code)"
            echo "Possible causes:"
            echo "  - DNS resolution failed for lankanewsroom.xyz"
            echo "  - Network connectivity issues"
            echo "  - SSL/TLS certificate problems"
            echo "  - Connection timeout (>30s)"
            exit 1
          fi
          
          # Check if status is 200 (success)
          if [ "$http_status" -eq 200 ]; then
            echo "‚úÖ Pipeline triggered successfully"
            # Check if pipeline was skipped (early exit)
            if echo "$body" | grep -q '"skipped":true'; then
              reason=$(echo "$body" | grep -o '"reason":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
              echo "‚ÑπÔ∏è  Pipeline skipped: $reason"
            else
              # Try to extract stats if available
              if echo "$body" | grep -q '"fetched"'; then
                fetched=$(echo "$body" | grep -o '"fetched":[0-9]*' | cut -d: -f2 || echo "?")
                inserted=$(echo "$body" | grep -o '"inserted":[0-9]*' | cut -d: -f2 || echo "?")
                echo "üìä Stats: fetched=$fetched, inserted=$inserted"
              fi
            fi
            exit 0
          elif [ "$http_status" -eq 401 ]; then
            echo "‚ùå Authentication failed (401)"
            echo "Check that CRON_SECRET matches in both GitHub and Vercel (Production)"
            echo "Current secret starts with: ${CRON_SECRET:0:8}..."
            exit 1
          elif [ "$http_status" -eq 404 ]; then
            echo "‚ùå Endpoint not found (404)"
            echo "Check that /api/cron/run exists and domain is correctly configured"
            echo "Tried: ${ENDPOINT}"
            exit 1
          elif [ "$http_status" -eq 500 ]; then
            echo "‚ùå Server error (500)"
            echo "Check Vercel logs for detailed error information"
            echo "Response: $body"
            exit 1
          elif [ "$http_status" -eq 503 ]; then
            echo "‚ùå Service unavailable (503)"
            echo "The endpoint may be temporarily unavailable or rate-limited"
            exit 1
          elif [ "$http_status" = "000" ]; then
            echo "‚ùå Connection failed - no HTTP response received"
            echo "Check DNS configuration for lankanewsroom.xyz"
            echo "Curl exit code: $curl_exit_code"
            exit 1
          else
            echo "‚ùå Pipeline request failed with status $http_status"
            echo "Response: $body"
            exit 1
          fi

