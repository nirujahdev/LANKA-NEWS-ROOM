name: Trigger Pipeline Cron (15 min)

# ============================================
# SETUP INSTRUCTIONS
# ============================================
# Before this workflow can run, you must:
# 1. Go to GitHub Repo → Settings → Secrets and variables → Actions
# 2. Click "New repository secret"
# 3. Name: CRON_SECRET
# 4. Value: Same as your Vercel CRON_SECRET environment variable (Production)
# 5. Click "Add secret"
#
# IMPORTANT: CRON_SECRET must match exactly in both places:
# - GitHub Secrets → Actions → CRON_SECRET
# - Vercel → Project Settings → Environment Variables → CRON_SECRET (Production)
# ============================================

on:
  # Schedule: Every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  
  # Manual trigger (for testing)
  workflow_dispatch:

jobs:
  trigger-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call pipeline endpoint
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "❌ CRON_SECRET secret is not set"
            echo "Please set CRON_SECRET secret in GitHub Settings → Secrets → Actions"
            exit 1
          fi
          
          # Using custom domain: lankanewsroom.xyz
          DOMAIN="lankanewsroom.xyz"
          ENDPOINT="https://${DOMAIN}/api/cron/run"
          
          echo "Triggering pipeline at ${ENDPOINT}"
          
          # Make request with Bearer token authentication
          # --fail flag makes curl exit with non-zero status on HTTP errors
          # --silent --show-error suppresses progress but shows errors
          # --write-out prints status code and response
          response=$(curl \
            --fail \
            --silent \
            --show-error \
            --write-out "\nHTTP_STATUS:%{http_code}\n" \
            --header "Authorization: Bearer ${CRON_SECRET}" \
            --header "Content-Type: application/json" \
            "${ENDPOINT}" 2>&1)
          
          # Extract HTTP status code
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "000")
          body=$(echo "$response" | grep -v "HTTP_STATUS:")
          
          echo "HTTP Status: $http_status"
          echo "Response: $body"
          
          # Check if status is 200 (success)
          if [ "$http_status" -eq 200 ]; then
            echo "✅ Pipeline triggered successfully"
            # Check if pipeline was skipped (early exit)
            if echo "$body" | grep -q '"skipped":true'; then
              reason=$(echo "$body" | grep -o '"reason":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
              echo "ℹ️  Pipeline skipped: $reason"
            fi
          elif [ "$http_status" -eq 401 ]; then
            echo "❌ Authentication failed (401)"
            echo "Check that CRON_SECRET matches in both GitHub and Vercel (Production)"
            exit 1
          elif [ "$http_status" -eq 404 ]; then
            echo "❌ Endpoint not found (404)"
            echo "Check that /api/cron/run exists and domain is correctly configured"
            exit 1
          elif [ "$http_status" -eq 000 ]; then
            echo "❌ Connection failed"
            echo "Check DNS configuration for lankanewsroom.xyz"
            exit 1
          else
            echo "❌ Pipeline request failed with status $http_status"
            exit 1
          fi

