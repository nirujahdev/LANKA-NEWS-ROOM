name: AI News Agent Pipeline

# ============================================
# SETUP INSTRUCTIONS
# ============================================
# Before this workflow can run, you must:
# 1. Go to GitHub Repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
# 2. Add the following secrets:
#    - SUPABASE_URL: Your Supabase project URL
#    - SUPABASE_SERVICE_ROLE_KEY: Your Supabase service role key (for writes)
#    - OPENAI_API_KEY: Your OpenAI API key
# 3. Optionally set:
#    - AGENT_ENABLED: Enable agents (default: false, set to 'true' to enable)
#    - AGENT_ROLLOUT_PERCENTAGE: Percentage of traffic to route to agents (0-100, default: 0)
#    - AGENT_USE_FOR_COMPLEX: Use agents for complex cases (default: true)
#    - AGENT_SUMMARY_MODEL: Model for summary agent (default: gpt-4o-mini)
#    - AGENT_TRANSLATION_MODEL: Model for translation agent (default: gpt-4o-mini)
#    - AGENT_SEO_MODEL: Model for SEO agent (default: gpt-4o-mini)
#    - AGENT_IMAGE_MODEL: Model for image agent (default: gpt-4o)
#    - AGENT_CATEGORY_MODEL: Model for category agent (default: gpt-4o-mini)
# ============================================

on:
  # Schedule: Every 30 minutes
  schedule:
    - cron: '*/30 * * * *'
  
  # Manual trigger (for testing)
  workflow_dispatch:
    inputs:
      force:
        description: 'Force run (bypass lock)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Prevent concurrent runs - queue new runs instead of canceling
# This ensures all runs complete, even if triggered multiple times
concurrency:
  group: ai-agent-pipeline
  cancel-in-progress: false

jobs:
  ai-agent-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Verify environment variables
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ]; then
            echo "‚ùå SUPABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå SUPABASE_SERVICE_ROLE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"

      - name: Run AI Agent Pipeline
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Agent configuration
          AGENT_ENABLED: ${{ secrets.AGENT_ENABLED || 'true' }}
          AGENT_ROLLOUT_PERCENTAGE: ${{ secrets.AGENT_ROLLOUT_PERCENTAGE || '100' }}
          AGENT_USE_FOR_COMPLEX: ${{ secrets.AGENT_USE_FOR_COMPLEX || 'true' }}
          AGENT_QUALITY_THRESHOLD: ${{ secrets.AGENT_QUALITY_THRESHOLD || '0.7' }}
          AGENT_MAX_RETRIES: ${{ secrets.AGENT_MAX_RETRIES || '3' }}
          AGENT_TIMEOUT: ${{ secrets.AGENT_TIMEOUT || '60000' }}
          # Model configuration
          AGENT_SUMMARY_MODEL: ${{ secrets.AGENT_SUMMARY_MODEL || 'gpt-4o-mini' }}
          AGENT_TRANSLATION_MODEL: ${{ secrets.AGENT_TRANSLATION_MODEL || 'gpt-4o-mini' }}
          AGENT_SEO_MODEL: ${{ secrets.AGENT_SEO_MODEL || 'gpt-4o-mini' }}
          AGENT_IMAGE_MODEL: ${{ secrets.AGENT_IMAGE_MODEL || 'gpt-4o' }}
          AGENT_CATEGORY_MODEL: ${{ secrets.AGENT_CATEGORY_MODEL || 'gpt-4o-mini' }}
        run: |
          echo "ü§ñ Starting AI News Agent Pipeline..."
          echo "   AGENT_ENABLED: ${AGENT_ENABLED}"
          echo "   AGENT_ROLLOUT_PERCENTAGE: ${AGENT_ROLLOUT_PERCENTAGE}%"
          echo "   AGENT_USE_FOR_COMPLEX: ${AGENT_USE_FOR_COMPLEX}"
          echo ""
          echo "üìã AI Agent Pipeline features:"
          echo "   ‚úì Summary generation via Summary Agent"
          echo "   ‚úì Translation via Translation Agent (multi-language)"
          echo "   ‚úì SEO generation via SEO Agent"
          echo "   ‚úì Image selection via Image Agent"
          echo "   ‚úì Categorization via Category Agent"
          echo "   ‚úì Quality tracking and metrics"
          echo ""
          
          # Run the AI agent pipeline script
          npx tsx scripts/ai-agent-pipeline.ts

      - name: Pipeline summary
        if: always()
        run: |
          echo ""
          echo "üìä AI Agent Pipeline run completed"
          echo "Check the logs above for detailed statistics"
          echo ""
          echo "Key metrics to review:"
          echo "  - Clusters processed"
          echo "  - Agent operations count"
          echo "  - Quality scores (summary, translation, SEO, image)"
          echo "  - Error count and details"

